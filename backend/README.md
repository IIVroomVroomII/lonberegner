# L√∏nberegning System - Backend API

Automatisk l√∏n- og tidsregistreringssystem baseret p√• Transport- og Logistikoverenskomsten 2025-2028.

## üìã Indholdsfortegnelse

- [Om Systemet](#om-systemet)
- [Funktionalitet](#funktionalitet)
- [Teknologi Stack](#teknologi-stack)
- [Kom i Gang](#kom-i-gang)
- [API Dokumentation](#api-dokumentation)
- [Databasestruktur](#databasestruktur)
- [Test](#test)
- [Deployment](#deployment)

## üéØ Om Systemet

Dette system implementerer en komplet l√∏sning til automatisk l√∏nberegning for transport- og logistikvirksomheder efter Transport- og Logistikoverenskomsten 2025-2028 mellem DIO I (ATL) og 3F's Transportgruppe.

### Overenskomstregler Implementeret

Systemet h√•ndterer alle v√¶sentlige regler fra overenskomsten:

- **¬ß 2**: L√∏n og till√¶g
- **¬ß 4**: Arbejdstid og arbejdstidsregler
- **¬ß 6**: Grundl√∏n (inkl. anciennitet)
- **¬ß 7**: Overarbejde (1-3 timer: 110%, 3+ timer: 120%)
- **¬ß 8**: S√¶rligt l√∏ntill√¶g/frihedskonto (9%)
- **¬ß 9**: Pension (arbejdsgiver: 9%, medarbejder: 3%)
- **¬ß 11**: Fridage og seniorordning
- **¬ß 12-13**: Ferie og feriedagbonus
- **¬ß 14**: Sygel√∏n (fuld l√∏n fra dag 1)
- **¬ß 15**: Barsel (f√∏dende: 4 uger f√∏r + 14 uger efter, ikke-f√∏dende: 2 uger, social for√¶lder: op til 46 uger)
- **¬ß 16-17**: B√∏rns sygdom (1. + 2. frav√¶rsdag med fuld l√∏n, 3. dag med halv)
- **¬ß 21-22**: Opsigelse og fratr√¶delsesgodtg√∏relse
- **¬ß 23**: Kompetenceudvikling (6 dage/√•r garanteret)

### Specialoverenskomster

Systemet underst√∏tter f√∏lgende specialoverenskomster:

1. **Chauff√∏roverenskomst**: K√∏rsel, multi-drop, farligt gods, internationalt
2. **Lager- og Terminaloverenskomst**: Temperatur till√¶g, geografiske till√¶g, loading bonus
3. **Flytteoverenskomst**: Tunge l√∏ft, etagetill√¶g, emballering
4. **Gr√¶nseoverskridende arbejde**: Grejbanksatser, dagpenge efter zoner
5. **Dagrenovationsoverenskomst**: Akkordl√∏n, rutevanskelighed, vejrkompensation
6. **Holddriftsaftale**: Skiftehold, d√∏gnk√∏rsel, kompensationsdage
7. **L√¶rlingeoverenskomst**: Progressiv l√∏n (50%-60%-75%-90%), skoleperioder, eksamensbonus

## ‚ú® Funktionalitet

### Core Features

- ‚úÖ **Tidsregistrering** med automatisk validering mod arbejdstidsregler
- ‚úÖ **Automatisk l√∏nberegning** baseret p√• overenskomst og specialoverenskomster
- ‚úÖ **Overarbejde** med korrekt beregning af 110%/120% satser
- ‚úÖ **Fridage og frav√¶r** (ferie, sygdom, barsel, b√∏rneomsorg)
- ‚úÖ **Frihedskonto** med 9% s√¶rligt l√∏ntill√¶g
- ‚úÖ **Pension** (9% arbejdsgiver + 3% medarbejder)
- ‚úÖ **Anciennitetstill√¶g** og automatisk l√∏nopjustering
- ‚úÖ **Opsigelse og fratr√¶delsesgodtg√∏relse** beregning

### API Endpoints

#### Core Endpoints
- `/api/v1/auth` - Autentificering (login, logout, refresh token)
- `/api/v1/employees` - Medarbejderstyring
- `/api/v1/time-entries` - Tidsregistrering
- `/api/v1/payrolls` - L√∏nk√∏rsler og l√∏nsedler
- `/api/v1/dashboard` - Statistik og overblik
- `/api/v1/agreements` - Overenskomster
- `/api/v1/export` - Integration til l√∏nsystemer

#### Calculation Endpoints
- `/api/v1/salary` - L√∏nberegninger
- `/api/v1/overtime` - Overarbejdsberegning
- `/api/v1/days-off` - Fridage og frihedskonto
- `/api/v1/absence` - Frav√¶r (sygdom, barsel, b√∏rneomsorg)
- `/api/v1/termination` - Opsigelse og fratr√¶delsesgodtg√∏relse
- `/api/v1/education` - Kompetenceudvikling

#### Special Agreement Endpoints
- `/api/v1/cross-border` - Gr√¶nseoverskridende arbejde
- `/api/v1/warehouse` - Lager- og terminalarbejde
- `/api/v1/shift-work` - Holddriftsarbejde
- `/api/v1/waste-collection` - Dagrenovation
- `/api/v1/apprentice` - L√¶rlinge

## üõ†Ô∏è Teknologi Stack

### Backend
- **Runtime**: Node.js 18+
- **Framework**: Express.js
- **Language**: TypeScript (strict mode)
- **Database**: PostgreSQL 14+
- **ORM**: Prisma
- **Validation**: Zod
- **Authentication**: JWT + bcrypt
- **Logging**: Winston
- **API Docs**: Swagger/OpenAPI 3.0
- **Testing**: Jest (622 tests)

### Dependencies
```json
{
  "express": "^4.18.2",
  "prisma": "^5.7.0",
  "@prisma/client": "^5.7.0",
  "typescript": "^5.3.3",
  "zod": "^3.22.4",
  "bcryptjs": "^2.4.3",
  "jsonwebtoken": "^9.0.2",
  "winston": "^3.11.0",
  "swagger-jsdoc": "^6.2.8",
  "swagger-ui-express": "^5.0.0",
  "decimal.js": "^10.4.3"
}
```

## üöÄ Kom i Gang

### Foruds√¶tninger

- Node.js 18 eller nyere
- PostgreSQL 14 eller nyere
- npm eller yarn

### Installation

1. **Klon repository**
   ```bash
   cd backend
   ```

2. **Installer dependencies**
   ```bash
   npm install
   ```

3. **Ops√¶t milj√∏variabler**

   Opret en `.env` fil i `backend/` mappen:
   ```env
   # Database
   DATABASE_URL="postgresql://user:password@localhost:5432/lonberegning"

   # JWT
   JWT_SECRET="your-super-secret-jwt-key-change-this-in-production"
   JWT_EXPIRES_IN="1h"
   JWT_REFRESH_SECRET="your-super-secret-refresh-key"
   JWT_REFRESH_EXPIRES_IN="7d"

   # Server
   NODE_ENV="development"
   PORT=3000
   CORS_ORIGIN="http://localhost:5173"

   # Logging
   LOG_LEVEL="info"
   ```

4. **K√∏r database migrationer**
   ```bash
   npx prisma migrate dev
   ```

5. **Seed database med testdata**
   ```bash
   npm run seed
   ```

6. **Start development server**
   ```bash
   npm run dev
   ```

Server k√∏rer nu p√• `http://localhost:3000`

### Test Login Credentials

Efter seeding har du adgang til f√∏lgende test-brugere:

- **Admin**: `admin@lonberegning.dk` / `admin123`
- **L√∏n Manager**: `manager@lonberegning.dk` / `manager123`
- **Medarbejder**: `medarbejder1@lonberegning.dk` / `employee123`

## üìö API Dokumentation

### Swagger UI

N√•r serveren k√∏rer, kan du tilg√• den interaktive API dokumentation p√•:

- **Swagger UI**: http://localhost:3000/api-docs
- **OpenAPI Spec (JSON)**: http://localhost:3000/api-docs.json

### Autentificering

Alle endpoints (undtagen `/auth/login` og `/health`) kr√¶ver autentificering via JWT token.

**Login eksempel:**
```bash
curl -X POST http://localhost:3000/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "admin@lonberegning.dk",
    "password": "admin123"
  }'
```

**Response:**
```json
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "user": {
    "id": "...",
    "email": "admin@lonberegning.dk",
    "name": "Admin Bruger",
    "role": "ADMIN"
  }
}
```

**Brug token i efterf√∏lgende requests:**
```bash
curl -X GET http://localhost:3000/api/v1/employees \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
```

### Eksempel: Beregn L√∏n

```bash
curl -X POST http://localhost:3000/api/v1/salary/calculate \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "employeeId": "employee-uuid",
    "regularHours": 160,
    "allowances": {
      "multiDropDeliveries": 50,
      "dangerousGoodsHours": 10
    }
  }'
```

### Eksempel: Beregn Overarbejde

```bash
curl -X POST http://localhost:3000/api/v1/overtime/calculate \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "employeeId": "employee-uuid",
    "overtimeHours": 5,
    "date": "2025-01-15T00:00:00Z",
    "isWeekend": false
  }'
```

## üóÑÔ∏è Databasestruktur

### Prim√¶re Tabeller

- **User**: Brugere med roller (ADMIN, PAYROLL_MANAGER, MANAGER, EMPLOYEE)
- **Employee**: Medarbejdere med CPR, anciennitet, jobkategori
- **Agreement**: Overenskomster med satser og regler
- **TimeEntry**: Tidsregistreringer
- **Payroll**: L√∏nk√∏rsler
- **PayrollEntry**: Individuelle l√∏nposter

### Prisma Schema

Se `prisma/schema.prisma` for den komplette databasestruktur.

**Generer Prisma Client:**
```bash
npx prisma generate
```

**√Öbn Prisma Studio (database GUI):**
```bash
npx prisma studio
```

## üß™ Test

Systemet har 622 omfattende unit tests der tester alle overenskomstregler.

### K√∏r alle tests
```bash
npm test
```

### K√∏r tests i watch mode
```bash
npm run test:watch
```

### Test coverage
```bash
npm run test:coverage
```

### Test Kategorier

- **Salary Tests**: Grundl√∏n, till√¶g, anciennitet (50 tests)
- **Overtime Tests**: 110%/120% satser, weekend, nat (54 tests)
- **Days Off Tests**: Frihedskonto, seniorordning, feriedagbonus (48 tests)
- **Absence Tests**: Sygdom, barsel, b√∏rneomsorg (52 tests)
- **Termination Tests**: Opsigelse, beskyttelse, fratr√¶delsesgodtg√∏relse (46 tests)
- **Education Tests**: Kompetenceudvikling, garanterede dage (44 tests)
- **Cross-Border Tests**: Grejbank, dagpenge, zoner (50 tests)
- **Warehouse Tests**: Temperatur till√¶g, loading, geografiske till√¶g (50 tests)
- **Shift Work Tests**: Skiftehold, kompensationsdage, rotation (54 tests)
- **Waste Collection Tests**: Akkordl√∏n, vejrkompensation, rutevanskelighed (54 tests)
- **Apprentice Tests**: Progressiv l√∏n, skoleperioder, eksamensbonus (50 tests)
- **Moving Tests**: Tunge l√∏ft, etagetill√¶g, emballering (50 tests)
- **Driver Tests**: Multi-drop, farligt gods, international k√∏rsel (50 tests)

## üö¢ Deployment

### Production Build

```bash
npm run build
```

Dette genererer kompileret JavaScript i `dist/` mappen.

### Start Production Server

```bash
npm start
```

### Environment Variables (Production)

S√∏rg for at s√¶tte f√∏lgende milj√∏variabler i production:

```env
NODE_ENV=production
DATABASE_URL=postgresql://...
JWT_SECRET=strong-random-secret
JWT_REFRESH_SECRET=another-strong-random-secret
PORT=3000
CORS_ORIGIN=https://your-frontend-domain.com
LOG_LEVEL=warn
```

### Database Migration (Production)

```bash
npx prisma migrate deploy
```

### Heroku Deployment

Systemet er konfigureret til Heroku deployment:

```bash
# Login til Heroku
heroku login

# Opret app (hvis ikke allerede oprettet)
heroku create lonberegning-system

# Tilf√∏j PostgreSQL database
heroku addons:create heroku-postgresql:mini

# Set environment variables
heroku config:set JWT_SECRET=your-secret
heroku config:set JWT_REFRESH_SECRET=your-refresh-secret

# Deploy
git push heroku main

# K√∏r migrations
heroku run npx prisma migrate deploy

# Seed database (optional)
heroku run npm run seed
```

## üìñ Dokumentation

### Projektstruktur

```
backend/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ config/           # Configuration (database, logger, swagger)
‚îÇ   ‚îú‚îÄ‚îÄ controllers/      # HTTP request handlers
‚îÇ   ‚îú‚îÄ‚îÄ middleware/       # Express middleware (auth, validation, error handling)
‚îÇ   ‚îú‚îÄ‚îÄ routes/           # API route definitions
‚îÇ   ‚îú‚îÄ‚îÄ services/         # Business logic (19 service modules)
‚îÇ   ‚îú‚îÄ‚îÄ validators/       # Zod validation schemas
‚îÇ   ‚îú‚îÄ‚îÄ __tests__/        # Jest test files (622 tests)
‚îÇ   ‚îú‚îÄ‚îÄ index.ts          # Application entry point
‚îÇ   ‚îî‚îÄ‚îÄ seed.ts           # Database seeder
‚îú‚îÄ‚îÄ prisma/
‚îÇ   ‚îî‚îÄ‚îÄ schema.prisma     # Database schema
‚îú‚îÄ‚îÄ dist/                 # Compiled JavaScript (generated)
‚îú‚îÄ‚îÄ package.json
‚îú‚îÄ‚îÄ tsconfig.json
‚îî‚îÄ‚îÄ README.md
```

### Service Moduler

Alle 19 overenskomstregler er implementeret som separate service moduler:

1. `salaryService.ts` - Grundl√∏n og till√¶g
2. `overtimeService.ts` - Overarbejde (¬ß 7)
3. `daysOffService.ts` - Frihedskonto og fridage (¬ß 8, ¬ß 11)
4. `absenceService.ts` - Sygdom, barsel, b√∏rneomsorg (¬ß 14-17)
5. `terminationService.ts` - Opsigelse (¬ß 21)
6. `severanceService.ts` - Fratr√¶delsesgodtg√∏relse (¬ß 22)
7. `educationService.ts` - Kompetenceudvikling (¬ß 23)
8. `pensionService.ts` - Pension (¬ß 9)
9. `holidayService.ts` - Ferie (¬ß 12-13)
10. `driverService.ts` - Chauff√∏roverenskomst
11. `warehouseTerminalService.ts` - Lager- og terminaloverenskomst
12. `moverService.ts` - Flytteoverenskomst
13. `crossBorderService.ts` - Gr√¶nseoverskridende arbejde
14. `wasteCollectionService.ts` - Dagrenovationsoverenskomst
15. `shiftWorkService.ts` - Holddriftsaftale
16. `apprenticeService.ts` - L√¶rlingeoverenskomst
17. `validationService.ts` - Arbejdstidsvalidering
18. `timeEntryService.ts` - Tidsregistrering
19. `payrollService.ts` - L√∏nk√∏rsler

## ü§ù Support

For sp√∏rgsm√•l eller support, kontakt:
- **Email**: support@lonberegning.dk
- **API Docs**: http://localhost:3000/api-docs

## üìÑ Licens

MIT License - se LICENSE fil for detaljer.

## üéØ Roadmap

- [ ] Frontend implementation (React + Vite)
- [ ] Real-time notifications (WebSockets)
- [ ] Advanced reporting and analytics
- [ ] Integration med e-conomic, Danl√∏n, ProL√∏n
- [ ] Mobile app for medarbejdere
- [ ] GPS/Takograf integration
- [ ] AI-baseret anomali detektion
